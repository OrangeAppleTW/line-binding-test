<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- Viewport 設定：禁止縮放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>橘子蘋果程式學苑 會員綁定</title>
    <!-- 引入 LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        background-color: #ffffff; 
      }
      
      .container { 
        max-width: 600px; 
        margin-top: 20px; 
        padding: 20px;
      }

      .content-area { 
        border: none; 
        box-shadow: none; 
      }

      .user-id-display { 
        font-size: 0.85rem; 
        color: #6c757d; 
        background: #f8f9fa; 
        padding: 5px 15px; 
        border-radius: 20px; 
        display: inline-block; 
        margin-bottom: 25px; 
      }

      /* 自定義橘色按鈕 */
      .btn-orange {
        background-color: #ffa300;
        border-color: #ffa300;
        color: white;
        font-weight: bold;
      }
      .btn-orange:hover, .btn-orange:active, .btn-orange:focus {
        background-color: #e59200; 
        border-color: #e59200;
        color: white;
      }
      .btn-orange:disabled {
        background-color: #ffe0b2;
        border-color: #ffe0b2;
      }

      /* 外框按鈕樣式 (用於發送驗證碼) */
      .btn-outline-orange {
        color: #ffa300;
        border-color: #ffa300;
      }
      .btn-outline-orange:hover {
        background-color: #ffa300;
        color: white;
      }
      
      .hidden-section {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="content-area">
        <h4 class="mb-4 text-center fw-bold">橘子蘋果程式學苑<br>會員綁定</h4>
        
        <!-- 顯示 LINE User ID -->
        <div class="text-center">
          <span id="userIdDisplay" class="user-id-display">讀取中...</span>
        </div>

        <div id="form">
          <p class="text-muted text-center small mb-4">
            請驗證您的手機號碼以完成與官方帳號的連動。
          </p>

          <!-- 1. 手機號碼區塊 (含發送按鈕) -->
          <div class="mb-3">
            <label for="phone" class="form-label fw-bold">手機號碼</label>
            <div class="input-group">
              <input type="tel" id="phone" class="form-control form-control-lg" placeholder="例如：0912345678">
              <button class="btn btn-outline-orange" type="button" id="sendCodeBtn" onclick="sendVerificationCode()">
                發送驗證碼
              </button>
            </div>
            <div id="phoneFeedback" class="form-text text-danger" style="display:none;"></div>
          </div>

          <!-- 2. 驗證碼區塊 (預設隱藏) -->
          <div id="verifySection" class="hidden-section mb-3">
            <label for="verificationCode" class="form-label fw-bold">簡訊驗證碼</label>
            <input type="text" id="verificationCode" class="form-control form-control-lg" placeholder="請輸入 6 位數驗證碼" maxlength="6">
            <div class="form-text text-success">驗證碼已發送至您的手機</div>
          </div>

          <!-- 3. Email 區塊 (預設隱藏，只有 userExist=false 時才顯示) -->
          <div id="emailSection" class="hidden-section mb-4">
            <label for="email" class="form-label fw-bold">電子信箱 (註冊用)</label>
            <input type="email" id="email" class="form-control form-control-lg" placeholder="請輸入 Email 進行註冊">
            <div class="form-text text-muted">您的手機尚未註冊，請補充 Email 以完成帳號建立。</div>
          </div>
          
          <!-- 送出按鈕 -->
          <button id="submitBtn" onclick="submitFinalBind()" class="btn btn-orange w-100 btn-lg mt-3" disabled>
            綁定
          </button>
        </div>
        
        <!-- Loading 狀態 -->
        <div id="loading" class="text-center mt-3" style="display:none;">
          <div class="spinner-border text-secondary" role="status"></div>
          <p id="loadingText" class="mt-2 text-muted">資料處理中...</p>
        </div>
      </div>
    </div>

    <script>
      // ★★★ 設定區 ★★★
      var myLiffId = '2008639214-GoVOkE9D'; 
      
      // 定義 API 路徑
      const API_PATHS = {
        CHECK_USER: '/api/line-binding/check-user-and-send-code',
        BIND_SUBMIT: '/api/line-binding/submit' // 假設的最終送出路徑
      };

      // 用來記錄當前狀態
      let currentState = {
        phoneVerified: false,
        isNewUser: false, // 後端回傳 userExist=false 時設為 true
        lineUserId: null
      };

      window.onload = function() {
        initializeLiff(myLiffId);
      };

      function initializeLiff(liffId) {
        liff.init({ liffId: liffId })
          .then(() => {
            if (!liff.isLoggedIn()) {
              liff.login();
            } else {
              liff.getProfile()
                .then(profile => {
                  currentState.lineUserId = profile.userId;
                  document.getElementById('userIdDisplay').innerText = 'ID: ' + profile.userId;
                })
                .catch(err => {
                  console.error('Profile Error:', err);
                  document.getElementById('userIdDisplay').innerText = '無法讀取 ID';
                });
            }
          })
          .catch(err => {
            console.error('LIFF Init failed:', err);
            document.getElementById('userIdDisplay').innerText = '初始化失敗';
          });
      }

      // 步驟 1: 發送驗證碼並檢查用戶狀態
      function sendVerificationCode() {
        var phoneInput = document.getElementById('phone');
        var phone = phoneInput.value.trim();
        var feedback = document.getElementById('phoneFeedback');
        var sendBtn = document.getElementById('sendCodeBtn');

        // 簡單的手機格式驗證
        if (!phone || phone.length < 9) {
          feedback.innerText = '請輸入有效的手機號碼';
          feedback.style.display = 'block';
          return;
        }
        feedback.style.display = 'none';

        // 鎖定按鈕避免重複點擊
        sendBtn.disabled = true;
        sendBtn.innerText = '發送中...';

        // 呼叫後端 API
        fetch(API_PATHS.CHECK_USER, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            phone: phone,
            lineUserId: currentState.lineUserId 
          })
        })
        .then(response => response.json())
        .then(data => {
          // 假設後端回傳結構: { success: true, userExist: boolean, message: "..." }
          if (data.success) {
            // 鎖定手機欄位，不讓用戶隨意修改
            phoneInput.disabled = true;
            sendBtn.innerText = '已發送';
            
            // 顯示驗證碼輸入框
            document.getElementById('verifySection').style.display = 'block';
            
            // 開啟綁定按鈕
            document.getElementById('submitBtn').disabled = false;

            // 判斷用戶是否存在
            if (data.userExist === false) {
              // 用戶不存在 -> 顯示 Email 欄位，變更按鈕文字
              currentState.isNewUser = true;
              document.getElementById('emailSection').style.display = 'block';
              document.getElementById('submitBtn').innerText = '註冊並綁定';
            } else {
              // 用戶存在 -> 僅綁定
              currentState.isNewUser = false;
              document.getElementById('submitBtn').innerText = '確認綁定';
            }
            
          } else {
            alert('發送失敗：' + (data.message || '未知錯誤'));
            sendBtn.disabled = false;
            sendBtn.innerText = '發送驗證碼';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('系統錯誤，請稍後再試');
          sendBtn.disabled = false;
          sendBtn.innerText = '發送驗證碼';
        });
      }

      // 步驟 2: 最終送出 (綁定 或 註冊+綁定)
      function submitFinalBind() {
        var phone = document.getElementById('phone').value.trim();
        var code = document.getElementById('verificationCode').value.trim();
        var email = document.getElementById('email').value.trim();

        if (!code) {
          alert('請輸入驗證碼');
          return;
        }

        if (currentState.isNewUser && !email) {
          alert('新用戶請輸入 Email 以完成註冊');
          return;
        }

        // 切換 UI 為讀取中
        document.getElementById('form').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loadingText').innerText = currentState.isNewUser ? '註冊綁定中...' : '資料綁定中...';

        var payload = {
          lineUserId: currentState.lineUserId,
          phone: phone,
          verificationCode: code,
          isRegistration: currentState.isNewUser, // 告訴後端這是註冊還是純綁定
          email: currentState.isNewUser ? email : null
        };

        fetch(API_PATHS.BIND_SUBMIT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(response => {
           if (response.ok) return response.json();
           throw new Error('Network response was not ok.');
        })
        .then(data => {
          if (data.success) {
            alert(currentState.isNewUser ? '註冊並綁定成功！' : '綁定成功！');
            liff.closeWindow();
          } else {
            throw new Error(data.message || '操作失敗');
          }
        })
        .catch(error => {
          console.error('Submit Error:', error);
          alert('錯誤：' + (error.message || '無法連線到伺服器'));
          // 恢復顯示表單
          document.getElementById('form').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
        });
      }
    </script>
  </body>
</html>
